<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>8番出口風3Dゲーム</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    html,body { height:100%; margin:0; padding:0; overflow:hidden; }
    #gameCanvas { width:100vw; height:100vh; display:block; touch-action:none; }
    #ui {
      position:fixed; top:0; left:0; width:100vw; z-index:10; display:flex; flex-direction:column; align-items:center; pointer-events:none;
    }
    #msg {
      background:rgba(0,0,0,0.7); color:#fff; padding:8px 16px; border-radius:12px; font-size:1.2em; margin-top:10px; pointer-events:auto;
      max-width:90vw; text-align:center;
    }
    #hint {
      background:rgba(0,0,0,0.5); color:#ff0; padding:4px 12px; border-radius:10px; font-size:1em; margin-top:6px; pointer-events:auto;
      max-width:90vw; text-align:center;
    }
    #controls {
      position:fixed; bottom:30px; left:50%; transform:translateX(-50%); z-index:20; display:flex; gap:24px; pointer-events:auto;
    }
    .ctrlBtn {
      background:#0af; color:#fff; border:none; border-radius:16px; font-size:1.3em; padding:16px 32px; box-shadow:0 0 10px #0af; font-weight:bold;
    }
    .ctrlBtn:active { background:#0055ff; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/three@0.154.0/build/three.min.js"></script>
</head>
<body>
  <div id="ui">
    <div id="msg">異変を見逃さず出口を目指せ！</div>
    <div id="hint"></div>
  </div>
  <div id="controls">
    <button class="ctrlBtn" id="goBtn">進む</button>
    <button class="ctrlBtn" id="backBtn">引き返す</button>
  </div>
  <canvas id="gameCanvas"></canvas>
  <script>
    // ===== Three.js 基本セットアップ =====
    const canvas = document.getElementById('gameCanvas');
    const renderer = new THREE.WebGLRenderer({canvas,antialias:true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setClearColor(0x222233);
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 100);
    camera.position.set(0,1.6,4);
    camera.rotation.order = "YXZ";
    // ===== 通路・出口・看板 =====
    let corridor, door, sign, anomalyObj;
    function createCorridor(isOdd, anomalyType) {
      scene.clear();
      // 通路
      corridor = new THREE.Mesh(
        new THREE.BoxGeometry(8,3,16),
        new THREE.MeshStandardMaterial({color:isOdd?0x888888:0x666666,side:THREE.BackSide})
      );
      scene.add(corridor);
      // 出口ドア
      door = new THREE.Mesh(
        new THREE.BoxGeometry(2,2.5,0.2),
        new THREE.MeshStandardMaterial({color:0x333399})
      );
      door.position.set(0,1.25,-7.8);
      scene.add(door);
      // 看板
      sign = new THREE.Mesh(
        new THREE.PlaneGeometry(2,0.6),
        new THREE.MeshStandardMaterial({color:0xffffee})
      );
      sign.position.set(0,2.2,-6.5);
      scene.add(sign);
      // 異変
      anomalyObj = null;
      if(anomalyType!==null){
        if(anomalyType==0){ // 看板の文字色
          sign.material.color.set(0xff0000);
        }else if(anomalyType==1){ // ドアの色
          door.material.color.set(0xff9900);
        }else if(anomalyType==2){ // 通路の壁色
          corridor.material.color.set(0x00ff99);
        }else if(anomalyType==3){ // 看板が消える
          scene.remove(sign);
        }else if(anomalyType==4){ // 天井にライト追加
          anomalyObj = new THREE.PointLight(0xff00ff,1,10);
          anomalyObj.position.set(0,2.8,-3);
          scene.add(anomalyObj);
        }
      }
      // ライト
      scene.add(new THREE.AmbientLight(0xffffff,0.7));
      const dirLight = new THREE.DirectionalLight(0xffffff,0.7);
      dirLight.position.set(5,10,5);
      scene.add(dirLight);
      // カメラ初期位置
      camera.position.set(0,1.6,4);
      camera.rotation.set(0,0,0);
    }
    // ===== ゲーム状態 =====
    let step = 1;
    let anomaly = false;
    let anomalyType = null;
    let gameover = false;
    let cleared = false;
    // ===== UI =====
    const msg = document.getElementById('msg');
    const hint = document.getElementById('hint');
    const goBtn = document.getElementById('goBtn');
    const backBtn = document.getElementById('backBtn');
    function updateUI() {
      if(gameover){
        msg.textContent = '失敗！異変を見逃したか、異変がないのに引き返した！';
        hint.textContent = 'リロードで再挑戦できます';
        goBtn.disabled = true;
        backBtn.disabled = true;
        return;
      }
      if(cleared){
        msg.textContent = 'クリア！出口に到達！';
        hint.textContent = 'おめでとう！';
        goBtn.disabled = true;
        backBtn.disabled = true;
        return;
      }
      msg.textContent = `通路${step} 異変${anomaly?"あり":"なし"}`;
      if(anomaly){
        hint.textContent = '異変を感じたら引き返そう！スワイプで見回せます';
      }else{
        hint.textContent = '異変がなければ進もう！スワイプで見回せます';
      }
    }
    // ===== 異変生成 =====
    function nextStep(){
      step++;
      anomaly = Math.random()<0.3; // 30%で異変
      anomalyType = anomaly ? Math.floor(Math.random()*5) : null;
      createCorridor(step%2==1, anomalyType);
      updateUI();
    }
    // ===== 進む/引き返す判定 =====
    function moveCamera(forward=true){
      let targetZ = forward ? -6 : 8;
      let startZ = camera.position.z;
      let frames = 30;
      let dz = (targetZ-startZ)/frames;
      let i=0;
      function anim(){
        if(i<frames){
          camera.position.z += dz;
          i++;
          requestAnimationFrame(anim);
        }
      }
      anim();
    }
    goBtn.onclick=()=>{
      if(gameover||cleared)return;
      if(anomaly){
        // 異変を見逃して進んだ→失敗
        moveCamera(true);
        setTimeout(()=>{gameover=true;updateUI();},800);
      }else{
        // 異変なしで進む→次の通路
        moveCamera(true);
        setTimeout(()=>{nextStep();},800);
      }
    };
    backBtn.onclick=()=>{
      if(gameover||cleared)return;
      if(anomaly){
        // 異変ありで引き返す→クリア
        moveCamera(false);
        setTimeout(()=>{cleared=true;updateUI();},800);
      }else{
        // 異変なしで引き返す→1番出口（最初に戻る）
        moveCamera(false);
        setTimeout(()=>{
          step=1;
          anomaly=false;
          anomalyType=null;
          createCorridor(true,null);
          msg.textContent = '異変がないのに引き返した！1番出口に戻された';
          hint.textContent = 'もう一度進もう';
        },800);
      }
    };
    // ===== 視点操作（スワイプ/ドラッグ） =====
    let isTouching=false, lastX=0, lastY=0;
    function onStart(e){
      isTouching=true;
      const t = e.touches?e.touches[0]:e;
      lastX=t.clientX; lastY=t.clientY;
    }
    function onMove(e){
      if(!isTouching) return;
      const t = e.touches?e.touches[0]:e;
      const dx=(t.clientX-lastX)/window.innerWidth*2;
      const dy=(t.clientY-lastY)/window.innerHeight*2;
      camera.rotation.y -= dx*1.2;
      camera.rotation.x -= dy*0.8;
      camera.rotation.x = Math.max(-Math.PI/2+0.1, Math.min(Math.PI/2-0.1, camera.rotation.x));
      lastX=t.clientX; lastY=t.clientY;
    }
    function onEnd(){ isTouching=false; }
    canvas.addEventListener('touchstart',onStart); canvas.addEventListener('touchmove',onMove); canvas.addEventListener('touchend',onEnd);
    canvas.addEventListener('mousedown',onStart); canvas.addEventListener('mousemove',onMove); canvas.addEventListener('mouseup',onEnd);
    // ===== 初期描画 =====
    createCorridor(true,null);
    updateUI();
    // ===== レンダリングループ =====
    function animate(){
      requestAnimationFrame(animate);
      renderer.render(scene,camera);
    }
    animate();
    // ===== レスポンシブ対応 =====
    window.addEventListener('resize',()=>{
      renderer.setSize(window.innerWidth,window.innerHeight);
      camera.aspect=window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
    });
  </script>
</body>
</html>
